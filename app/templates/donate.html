{% extends "base.html" %}
{% block title %}Donate to SafemamaPikin{% endblock %}
{% block content %}
<div class="container" data-aos="fade-up">
    <div class="form-wrapper">
        <div class="form-container card">
            <h2>Support SafemamaPikin</h2>
            <p>Your contribution helps us provide vital health alerts to mothers in rural communities.</p>
            
            <form id="paymentForm">
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email-address" required placeholder="For receipt only">
                </div>
                
                <div class="form-group">
                    <label for="full_name">Full Name:</label>
                    <input type="text" id="full-name" required placeholder="Your name">
                </div>

                <div class="form-group">
                    <label for="amount">Amount (NGN):</label>
                    <input type="number" id="amount" required placeholder="e.g., 5000" min="100">
                </div>

                <div class="form-group checkbox-group" style="margin: 1rem 0;">
                    <input type="checkbox" id="is-public">
                    <label for="is-public" style="display:inline; font-weight:normal;">
                        Display my name on the <a href="{{ url_for('views.donor_wall') }}" target="_blank">Donor Wall</a>?
                    </label>
                    <br>
                    <small>If unchecked, your donation will be listed as "Anonymous".</small>
                </div>

                <div class="form-submit">
                    <button type="submit" class="btn" id="pay-btn">Donate Now</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
    const paymentForm = document.getElementById('paymentForm');
    const payBtn = document.getElementById('pay-btn');

    paymentForm.addEventListener("submit", function(e) {
        e.preventDefault();
        payBtn.disabled = true;
        payBtn.textContent = "Processing...";

        let email = document.getElementById("email-address").value;
        let amount = document.getElementById("amount").value;
        let fullName = document.getElementById("full-name").value;
        let isPublic = document.getElementById("is-public").checked;

        let handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}', // Passed from Flask view
            email: email,
            amount: amount * 100, // Paystack expects amount in kobo
            currency: 'NGN',
            metadata: {
                custom_fields: [
                    { display_name: "Donor Name", variable_name: "donor_name", value: fullName },
                    { display_name: "Public Consent", variable_name: "is_public", value: isPublic }
                ]
            },
            onClose: function(){
                alert('Transaction cancelled.');
                payBtn.disabled = false;
                payBtn.textContent = "Donate Now";
            },
            callback: function(response){
                // Send reference to backend for verification
                verifyTransaction(response.reference, email, amount, fullName, isPublic);
            }
        });

        handler.openIframe();
    });

    function verifyTransaction(ref, email, amount, name, isPublic) {
        fetch('/api/verify-donation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                reference: ref,
                email: email,
                amount: amount,
                full_name: name,
                is_public: isPublic
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                window.location.href = "{{ url_for('views.donor_wall') }}";
            } else {
                alert('Verification failed: ' + data.message);
                payBtn.disabled = false;
            }
        })
        .catch(err => console.error(err));
    }
</script>
{% endblock %}